;
;ษอออออออออออออออออออออออออออออออออออออออออออัออออออออออออัออออออออออออออออออออป
;บ FILE:\CADASM\R10\ROM\CADOS\INT_HAND.SRC   ณVERS:1.1    ณTIPO: INTERRUPT ASM บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ AUTORE: Colombo Daniele                   ณDATA: Mon  09-13-1993  20:15:45  บ
;ฬอออออออออออออออออออออออออออออออออออออออออออฯอออออออออออออออออออออออออออออออออน
;บ INCLUDE: \CADASM\R10\ROM\CADOS\IOPORT.SRC - \CADASM\R10\ROM\DRIVER\MACH.SRC บ
;ฬอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออน
;บ FUNZIONI PUBBLICHE: UIE URSTI     IHPIOA TXMON RXMON SPECINT IH_TXLDP       บ
;บ IH_RXLDP IH_ERRLDP                                                          บ
;ฬอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออน
;บ DESCRIZIONE: ROUTINE ASSEMBLER PER LA GESTIONE DEGLI INTERRUPT              บ
;บ Per indirizzare l'i/o interno deve essere indirizzata la porta con il bps   บ
;บ dell'indirizzo a zero, mentre per l'i/o esterno il bps dell'indirizzo deve  บ
;บ essere diverso da zero                                                      บ
;บ                                                                             บ
;บ ษอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป บ
;บ บ DATO SUL BUS INDIRIZZI PER TUTTE LE ISTRUZIONI DI I/O DELLA CPU HD64180 บ บ
;บ ฬอออออออออออออัอออออออออออออัอออออออออออออออออออออัอออออออออออออออออออออออน บ
;บ บ  ISTRUZIONE ณ  OPERANDO   ณ  BPS ADDRESS BUS    ณ   BMS ADDRESS BUS     บ บ
;บ วฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ บ
;บ บ    OUT      ณ  (nn),A     ณ    Accumulatore     ณ          nn           บ บ
;บ บ    OUT      ณ  (C),r      ณ    Registro B       ณ      Registro C       บ บ
;บ บ    OUTI     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    OUTD     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    OTIR     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    OTDR     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    IN       ณ  (nn),A     ณ    Accumulatore     ณ          nn           บ บ
;บ บ    IN       ณ  (C),r      ณ    Registro B       ณ      Registro C       บ บ
;บ บ    INI      ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    IND      ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    INIR     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    INDR     ณ             ณ    Registro B       ณ      Registro C       บ บ
;บ บ    OUT0     ณ  (nn),A     ณ        0            ณ          nn           บ บ
;บ บ    OTIM     ณ             ณ        0            ณ      Registro C       บ บ
;บ บ    OTDM     ณ             ณ        0            ณ      Registro C       บ บ
;บ บ    OTIMR    ณ             ณ        0            ณ      Registro C       บ บ
;บ บ    OTDMR    ณ             ณ        0            ณ      Registro C       บ บ
;บ บ    IN0      ณ  (nn),A     ณ        0            ณ          nn           บ บ
;บ บ             ณ             ณ                     ณ                       บ บ
;บ ศอออออออออออออฯอออออออออออออฯอออออออออออออออออออออฯอออออออออออออออออออออออผ บ
;ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ

    NAME INT_HANDLER

        FILE    \CADASM\R10\ROM\CADOS\IOPORT.SRC
        FILE    \CADASM\R10\ROM\DRIVER\MACH.SRC
        FILE    \CADASM\R10\ROM\DRIVER\SYS.SRC
        FILE    \CADASM\R10\ROM\DRIVER\LDSTRUCT.SRC

EXTRN   KEYCHAR

PUBLIC  UIE,URSTI,IHPIOA,TXMON,RXMON,SPECINT,IH_TXLDP,IH_RXLDP,IH_ERRLDP
	CSEG

;
;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : UIE                           ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Unespected Interrupt Error                                   บ
;บ Viene attivata da un interrupt non previsto in tabella                     บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
UIE:
	HALT


;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : URSTI                         ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Unespected RST Instruction                                   บ
;บ Viene attivata da una Istruzione RST non gestita                           บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
URSTI:
	POP    HL
	RET

;
;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : IHPIOA                        ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt da tastiera                                        บ
;บ Viene attivata da un interrupt dalla porta A del pio, legge il carattere   บ
;บ dalla porta del PIO e mette il carattere nel buffer di tastiera            บ
;บ Nessun carattere =letti                                                    บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
IHPIOA:
		EI
		PUSH	AF
		PUSH	BC
		LD	BC,PIOA_DR
		IN	A,(C)
		LD	(KEYCHAR),A
		POP	BC
		POP	AF
		RETI

;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : TXMON                         ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di fine trasmissione dalla porta B del SIO         บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
TXMON:
		HALT

;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : RXMON                         ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : PRINTF                                                 บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di ricezione porta B del SIO                       บ
;บ Stampa il dato ricevuto in HEX                                             บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
EXTRN		PRINTF

RXMON:
		EI
		SAVEREG
		LD	BC,SIOB_DR
		IN	E,(C)
		LD	D,0000H
		LD	HL,FORMAT__
		CALL	PRINTF
		RESTOREREG
		RETI

FORMAT__:
		DEFB ' %x'
		DEFB 00H
		DEFB 00H

;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : SPECINT                       ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : PUTC                                                   บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di condizione speciale                             บ
;บ Viene attivata da un interrupt dalla porta B del sio di ricezione          บ
;บ condizione speciale (es. parity error) invia un break in linea e stampa    บ
;บ un *                                                                       บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
EXTRN		PUTC

SPECINT:
		EI
		SAVEREG
		LD	L,'*'
		CALL 	PUTC
		LD	BC,SIOB_CR
		LD	A,SNDBRK
		OUT	(C),A
		LD	A,RESERR
		OUT	(C),A
		RESTOREREG
		RETI
;
;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : IH_TXLDP  >>>> SVILUPPO <<<<  ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di fine trasmissione da porta B SIO in caricamento บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
IH_TXLDP:
		HALT

;
;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : IH_RXLDP  >>>> SVILUPPO <<<<  ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : ENDPACK PUTC                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di ricezione porta B SIO                           บ
;บ La routine viene linkata quando e' attivo il caricamento di un file in     บ
;บ formato S-RECORD HITACHI, tale routine si appoggia ad un array di puntatoriบ
;บ che puntano ad una struttura di tipo LDBUF.                                บ
;บ Alla ricezione dell'interrupt viene mappato il decrittore corrente e viene บ
;บ controllato che il descrittore risuliti libero, in tal caso viene letto il บ
;บ carattere dal dispositivo di I/O, tolto il bit di parita'.                 บ
;บ Se il carattere indica la fine del pacchetto viene chiameta una routine c  บ
;บ che aggiorna il descrittore corrente ed si posiziona al prossimo           บ
;บ descrittore libero in caso contrario viene scaricato nel buffer il         บ
;บ carattere letto e vengono incrementati i campi relativi alla lunghezza del บ
;บ pacchetto ed il puntatore al prossimo carattere nel buffer.                บ
;บ La gestione di questo interrupt e' effettuata ad interrupt aperti per      บ
;บ permettere all'interrupt di clock piu' prioritario di inserirsi potendo    บ
;บ cosi' mantenere aggiornata la base tempi della cpu.                        บ
;บ                                                                            บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
CR		EQU	0DH

EXTRN		FREEBUF;		; puntatore buffer corrente vuoto
EXTRN		ENDPACK;		; Routine C gestione fine pacchetto
EXTRN		XOFF;			; Ferma il trasmettitore
EXTRN		XON;			; Riattiva il trasmettitore
IH_RXLDP:
		EI
		SAVEREG
		PUSH	IX
		LD 	IX,(FREEBUF)	; IX = PUNTATORE AD ARRAY PUNTATORI
		LD	L,(IX+0)        ; HL = PUNTATORE A DESCRITTORE
		LD	H,(IX+1)        ; SCAMBIO IX CON HL
		PUSH	HL
		POP	IX              ; IX = PUNTATORE A DESCRITTORE
		LD	A,(IX+0)
		OR	A
		JR	NZ,RXERROR	; il descrittore corrente NON E' LIBERO
		LD	BC,SIOB_DR
		IN	A,(C)
		AND	07FH
		CP	CR
		JR	Z,C_PACK        ; fine pacchetto
		LD	L,(IX+2)        ; HL = PUNTATORE SCARICO (ptchar)
		LD	H,(IX+3)
		LD	(HL),A          ; Scarico carattere
		INC	HL              ; incremento puntatore ptchar
		LD	(IX+2),L        ; Aggiorno descrittore
		LD	(IX+3),H
		INC	(IX+6)          ; Incremento lunghezza pacchetto
		POP	IX
		RESTOREREG
		RETI			; Fine interrupt
C_PACK:
		LD	L,(IX+2)    	; HL = PUNTATORE SCARICO (ptchar)
		LD	H,(IX+3)
		XOR	A
		LD	(HL),A          ; Scrivo il carattere di fine stringa (NULL)
		PUSH	IY
		CALL	ENDPACK		; Chiamo routine aggiornamento descrittori e puntatori
		POP	IY
		POP	IX
		RESTOREREG
		RETI                	; Fine interrupt
RXERROR:
		PUSH	IY
                LD      IX,LOADSTAT
                LD      L,(IX+LDGENER)
                LD      H,(IX+LDGENER+1)
                INC     HL
                LD      (IX+LDGENER),L
                LD      (IX+LDGENER+1),H
		LD	BC,SIOB_CR
		LD	A,RESERR
		OUT	(C),A
		POP	IY
		POP	IX
		RESTOREREG
		RETI

;
;ษออออออออออออออออออออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออป
;บ FUNZIONE : IH_ERRLDP >>>> SVILUPPO <<<<  ณDATE: Mon  09-13-1993  20:31:22  บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ INPUT : Nessuno                                                            บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ OUTPUT : Nessuno                                                           บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ FUNZIONI CHIAMATE : Nessuna                                                บ
;วฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ
;บ DESCRIZIONE : Interrupt di condizione speciale in fase di caricamento      บ
;บ Viene attivata da un interrupt dalla porta B del sio di ricezione          บ
;บ condizione speciale (es. parity error) invia un break in linea e stampa    บ
;บ un *                                                                       บ
;ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
IH_ERRLDP:
		EI
		SAVEREG
                PUSH    IX
                LD      IX,LOADSTAT
                LD      L,(IX+LDPARITYERR)
                LD      H,(IX+LDPARITYERR+1)
                INC     HL
                LD      (IX+LDPARITYERR),L
                LD      (IX+LDPARITYERR+1),H
                LD      BC,SIOB_CR
                LD      A,RESERR
		OUT	(C),A
                POP     IX
                RESTOREREG
		RETI

		END
